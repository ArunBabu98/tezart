name: Run tests

on:
  # Trigger the workflow on push or pull request
  push:
    branches:
      - main
  pull_request:

jobs:
  unit_tests:
    name: Unit tests
    runs-on: ubuntu-latest

    services:
      flextesa:
        image: othmanemtk/flextesa-delphibox:1.0.1
        ports:
        - 20000:20000
        options: >-
          -e block_time=2
          --health-cmd "curl -f localhost:20000/chains/main/mempool/pending_operations || exit 1"
          --health-interval 2s
          --health-timeout 60s

    steps:
    - name: Git checkout
      uses: actions/checkout@v2

    - uses: cedx/setup-dart@v2
      with:
        version: 2.12.0
        release-channel: beta

    - name: Dart pub get
      run: dart pub get

    - name: Documentation generation check
      run: |
        pub global activate dartdoc
        $HOME/.pub-cache/bin/dartdoc

    - name: Dart tests
      run: |
        cp .github/workflows/.env.ci .env.test
        ./tezart tests

    - name: Run Coverage
      run: |
        pub run test_coverage

    - name: Collect the code coverage
      uses: codecov/codecov-action@v1.2.1
      with:
        token: ${{secrets.CODECOV_TOKEN}} #required
        file: ./coverage/lcov.info

    - name: Analyse the package with pana 
      run: |
        ./tezart pana
        #echo "SCORE=$(tool/pana-output-parser)" >> $GITHUB_ENV
        SCORE=$(tool/pana-output-parser) && echo "::set-output name=SCORE::$SCORE"

    - name: Build pana bagde OK == 100
      if: steps.main.outputs.SCORE == 100
      uses: RubbaBoy/BYOB@v1.2.0
      with:
        NAME: pana
        LABEL: 'pub.dev Score'
        STATUS: ${{ steps.main.outputs.SCORE }}/100
        COLOR: green
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Build pana bagde KO < 100 
      if: steps.main.outputs.SCORE  < 100
      uses: RubbaBoy/BYOB@v1.2.0
      with:
        NAME: pana
        LABEL: 'pub.dev Score'
        STATUS: ${{ steps.main.outputs.SCORE }}/100
        COLOR: red
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}